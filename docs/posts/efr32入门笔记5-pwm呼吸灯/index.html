<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>EFR32 入门笔记 5: PWM 呼吸灯 | Yuyang Wang's Blog</title><meta name=keywords content="C,EFR32"><meta name=description content="本文参考官方例程 Platform - Blink PWM Bare-metal"><meta name=author content><link rel=canonical href=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/katex/katex.min.css><script defer src=/katex/katex.min.js></script><script defer src=/katex/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PG166B7MZ2"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PG166B7MZ2")}</script><meta property="og:url" content="https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/"><meta property="og:site_name" content="Yuyang Wang's Blog"><meta property="og:title" content="EFR32 入门笔记 5: PWM 呼吸灯"><meta property="og:description" content="本文参考官方例程 Platform - Blink PWM Bare-metal"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-18T20:25:55+08:00"><meta property="article:modified_time" content="2023-03-18T20:25:55+08:00"><meta property="article:tag" content="C"><meta property="article:tag" content="EFR32"><meta property="og:image" content="https://wangyuyang.me/img/cover.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wangyuyang.me/img/cover.jpg"><meta name=twitter:title content="EFR32 入门笔记 5: PWM 呼吸灯"><meta name=twitter:description content="本文参考官方例程 Platform - Blink PWM Bare-metal"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangyuyang.me/posts/"},{"@type":"ListItem","position":2,"name":"EFR32 入门笔记 5: PWM 呼吸灯","item":"https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"EFR32 入门笔记 5: PWM 呼吸灯","name":"EFR32 入门笔记 5: PWM 呼吸灯","description":"本文参考官方例程 Platform - Blink PWM Bare-metal","keywords":["C","EFR32"],"articleBody":"PWM 基本使用 安装 Service - Sleep Timer：\n以及：\n创建 instance 并修改配置：\nPB02 将为 PWM 的输出引脚。\nCC 为 Capture/Compare\nCDTI 应该是指 Dead Time Insertion，不清楚这里 “C” 的含义。\n然后修改 app.c 文件：\n// app.c #include \"sl_pwm.h\" #include \"sl_pwm_instances.h\" #include \"sl_sleeptimer.h\" uint8_t pwm_lut[] = { 0, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 10, 10, 10, 11, 11, 12, 12, 13, 13, 14, 15, 15, 16, 17, 17, 18, 19, 19, 20, 21, 22, 23, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 34, 35, 36, 37, 39, 40, 41, 43, 44, 46, 48, 49, 51, 53, 54, 56, 58, 60, 62, 64, 66, 68, 71, 73, 75, 78, 80, 83, 85, 88, 91, 94, 97, 100, }; void app_init(void) { // Enable PWM output sl_pwm_start(\u0026sl_pwm_led); } void app_process_action(void) { for (uint8_t i = 0; i \u003c 100; i++) { sl_pwm_set_duty_cycle(\u0026sl_pwm_led, pwm_lut[i]); sl_sleeptimer_delay_millisecond(6); if (i == 0) { sl_sleeptimer_delay_millisecond(190); } } for (uint8_t i = 100; i \u003e 0; i--) { sl_pwm_set_duty_cycle(\u0026sl_pwm_led, pwm_lut[i]); sl_sleeptimer_delay_millisecond(6); if (i == 100) { sl_sleeptimer_delay_millisecond(190); } } } 编译，烧录，结束。\nLut 数组是怎么来的？ 有点好奇官方例程里的这个 Lut 数组是用什么函数生成的：\nuint8_t pwm_lut[] = { 0, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 10, 10, 10, 11, 11, 12, 12, 13, 13, 14, 15, 15, 16, 17, 17, 18, 19, 19, 20, 21, 22, 23, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 34, 35, 36, 37, 39, 40, 41, 43, 44, 46, 48, 49, 51, 53, 54, 56, 58, 60, 62, 64, 66, 68, 71, 73, 75, 78, 80, 83, 85, 88, 91, 94, 97, 100, }; 拖到 Origin 里 plot 一下：\n看起来有点像指数函数？做一个非线性拟合：\n可以看到拟合结果非常好，Lut 满足：\n$$ y = 4.44837e^{0.03126x} - 4.58963 $$\n挺有意思的一个结果，猜测这样设计，是因为比起线性增加的函数，亮度指数增加的视觉效果会更好，但是这样猜测是否符合实际呢？\n过去在光度学里学过，人眼对亮度变化的响应并不是线性的，而是大致呈现为对数关系，换句话说，人眼对弱光的变化较为敏感，而对亮光的变化较为迟钝。\n有很多关于人眼对光照响应的研究，例如上图中蓝线为 Weber-Fechne’s Law，认为刺激强度和人类因刺激产生的感觉强度满足公式:\n$$ S = 2.3klog_{10}(I)+C $$\n这也是为什么天文学中“视星等”采用对数进行定义！\n红线为 Stevens’ Power Law，满足：\n$$ S = kI^a $$\n具体哪一种曲线更符合人眼的真实情况不在本文的讨论之列，有兴趣的话可参考这篇文章。\n从上面的讨论我们知道了，人眼对光照强度的响应呈现对数关系。也就是说，如果我们随时间线性提高光源的物理亮度，那么在人眼看来，光源的亮度的增速实际上是先快后慢的，看起来并不够平滑。\n如果我们希望人眼感知到的亮度是随时间线性增加的，那显然就需要换一种方法来调整光源的物理亮度，考虑到对数函数的反函数是指数函数，只需要使用指数方式，先慢后快的提高光源物理亮度，就有希望达到上述目的，这可能就是上述 Lut 采用指数函数的原因。\n实际上，如果我们把感知亮度作为横轴，光源真实亮度作为纵轴，就可以得到这样一条曲线：\nHuman factors studies have shown that the eye perceives light in a logarithmic manner, mathematically speaking, in an approximately squared power relationship. Figure 1 illustrates this relationship.\nA linear profile is the most intuitive since when the dimming control is set to 50% or at 50% of its slider range then the measured light level is at 50%. However, with a linear profile the changes in light level at the low end of the dimming range are quite large and are sometimes viewed as step changes instead of smooth changes. This is due to the fact that the eye response is logarithmic and these step changes are perceived as being even larger than the measured percentages are. That being said, linear dimming profiles are adequate for many lighting applications that simply require dimming to be used for adjusting the light level for various tasks and times of day. In these applications the light level is adjusted occasionally and left at this level for a long period of time. These applications actually comprise a majority of dimming requirements.\nThe best simulation of the eye response is achieved with a logarithmic dimming profile. Figure 1 shows the typical eye response curve but slightly different logarithmic profiles are used by various LED driver manufacturers to enhance dimming performance. In addition to mimicking the eye response better, a logarithmic dimming profile enhances dimming smoothness at the lowest dimming levels. With the advent of the latest LED drivers that can achieve dimming to levels of nearly 0%, the availability of a logarithmic profile becomes even more important. Logarithmic profiles are also valuable for high- lumen-output luminaires (5000 lumens and above) in that they enable the dimming performance to be smoother because of the inherently wide lumen range of the light fixture. Applications requiring artistically ulta-smooth dimming such as theaters will greatly benefit from using logarithmic dimming profiles in all lumen ranges.\n— Linear vs. Logarithmic Dimming — A White Paper1\nLinear vs. Logarithmic Dimming — A White Paper. ↩︎\n","wordCount":"683","inLanguage":"en","image":"https://wangyuyang.me/img/cover.jpg","datePublished":"2023-03-18T20:25:55+08:00","dateModified":"2023-03-18T20:25:55+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/"},"publisher":{"@type":"Organization","name":"Yuyang Wang's Blog","logo":{"@type":"ImageObject","url":"https://wangyuyang.me/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangyuyang.me/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangyuyang.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://wangyuyang.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://example.org title=Server><span>Server</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wangyuyang.me/>Home</a>&nbsp;»&nbsp;<a href=https://wangyuyang.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">EFR32 入门笔记 5: PWM 呼吸灯</h1><div class=post-description>本文参考官方例程 Platform - Blink PWM Bare-metal</div><div class=post-meta><span title='2023-03-18 20:25:55 +0800 CST'>March 18, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;683 words</div></header><figure class=entry-cover><img loading=eager srcset='https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/cover_hu_9bba2c4c878395fb.jpg 360w,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/cover_hu_b01fd53cdf67ae51.jpg 480w,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/cover_hu_ea23b823344b18d.jpg 720w,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/cover_hu_fcbc0f5b2c0e6ed8.jpg 1080w,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/cover_hu_1fee0ae006f62098.jpg 1500w,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/cover.jpg 1920w' src=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/cover.jpg sizes="(min-width: 768px) 720px, 100vw" width=1920 height=1442 alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#pwm>PWM</a><ul><li><a href=#基本使用>基本使用</a></li><li><a href=#lut-数组是怎么来的>Lut 数组是怎么来的？</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=pwm>PWM<a hidden class=anchor aria-hidden=true href=#pwm>#</a></h2><h3 id=基本使用>基本使用<a hidden class=anchor aria-hidden=true href=#基本使用>#</a></h3><p>安装 Service - Sleep Timer：</p><p><img alt="Sleep Timer" loading=lazy src=/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/SleepTimer.png#center></p><p>以及：</p><p><img alt=PWM loading=lazy src=/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/PWM.png#center></p><p>创建 instance 并修改配置：</p><p><img alt="PWM Config" loading=lazy src=/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/PWMConfig.png#center></p><p><code>PB02</code> 将为 PWM 的输出引脚。</p><blockquote><p>CC 为 Capture/Compare</p><p>CDTI 应该是指 Dead Time Insertion，不清楚这里 “C” 的含义。</p></blockquote><p>然后修改 <code>app.c</code> 文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// app.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_pwm.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_pwm_instances.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_sleeptimer.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uint8_t</span> pwm_lut[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>11</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>17</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>25</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>34</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>36</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>37</span>, <span style=color:#ae81ff>39</span>, <span style=color:#ae81ff>40</span>, <span style=color:#ae81ff>41</span>, <span style=color:#ae81ff>43</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>49</span>, <span style=color:#ae81ff>51</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>53</span>, <span style=color:#ae81ff>54</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>68</span>, <span style=color:#ae81ff>71</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>73</span>, <span style=color:#ae81ff>75</span>, <span style=color:#ae81ff>78</span>, <span style=color:#ae81ff>80</span>, <span style=color:#ae81ff>83</span>, <span style=color:#ae81ff>85</span>, <span style=color:#ae81ff>88</span>, <span style=color:#ae81ff>91</span>, <span style=color:#ae81ff>94</span>, <span style=color:#ae81ff>97</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Enable PWM output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sl_pwm_start</span>(<span style=color:#f92672>&amp;</span>sl_pwm_led);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_process_action</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint8_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sl_pwm_set_duty_cycle</span>(<span style=color:#f92672>&amp;</span>sl_pwm_led, pwm_lut[i]);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sl_sleeptimer_delay_millisecond</span>(<span style=color:#ae81ff>6</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sl_sleeptimer_delay_millisecond</span>(<span style=color:#ae81ff>190</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint8_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>; i <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>; i<span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sl_pwm_set_duty_cycle</span>(<span style=color:#f92672>&amp;</span>sl_pwm_led, pwm_lut[i]);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sl_sleeptimer_delay_millisecond</span>(<span style=color:#ae81ff>6</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>==</span> <span style=color:#ae81ff>100</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sl_sleeptimer_delay_millisecond</span>(<span style=color:#ae81ff>190</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>编译，烧录，结束。</p><h3 id=lut-数组是怎么来的>Lut 数组是怎么来的？<a hidden class=anchor aria-hidden=true href=#lut-数组是怎么来的>#</a></h3><p>有点好奇官方例程里的这个 Lut 数组是用什么函数生成的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>uint8_t</span> pwm_lut[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>11</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>17</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>25</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>34</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>36</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>37</span>, <span style=color:#ae81ff>39</span>, <span style=color:#ae81ff>40</span>, <span style=color:#ae81ff>41</span>, <span style=color:#ae81ff>43</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>49</span>, <span style=color:#ae81ff>51</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>53</span>, <span style=color:#ae81ff>54</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>68</span>, <span style=color:#ae81ff>71</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>73</span>, <span style=color:#ae81ff>75</span>, <span style=color:#ae81ff>78</span>, <span style=color:#ae81ff>80</span>, <span style=color:#ae81ff>83</span>, <span style=color:#ae81ff>85</span>, <span style=color:#ae81ff>88</span>, <span style=color:#ae81ff>91</span>, <span style=color:#ae81ff>94</span>, <span style=color:#ae81ff>97</span>,
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>拖到 Origin 里 plot 一下：</p><p><img alt="PWM Lut" loading=lazy src=/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/Lut.svg#center></p><p>看起来有点像指数函数？做一个非线性拟合：</p><p><img alt="Nonlinear Regression" loading=lazy src=/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/NonlinearRegression.svg#center></p><p>可以看到拟合结果非常好，Lut 满足：</p><p>$$
y = 4.44837e^{0.03126x} - 4.58963
$$</p><p>挺有意思的一个结果，猜测这样设计，是因为比起线性增加的函数，亮度指数增加的视觉效果会更好，但是这样猜测是否符合实际呢？</p><p>过去在光度学里学过，人眼对亮度变化的响应并不是线性的，而是大致呈现为对数关系，换句话说，人眼对弱光的变化较为敏感，而对亮光的变化较为迟钝。</p><p><img alt="Weber-Fechner&rsquo;s Law and Stevens&rsquo; Power Law" loading=lazy src=/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/Bright.png#center></p><p>有很多关于人眼对光照响应的研究，例如上图中蓝线为 Weber-Fechne&rsquo;s Law，认为刺激强度和人类因刺激产生的感觉强度满足公式:</p><p>$$
S = 2.3klog_{10}(I)+C
$$</p><blockquote><p>这也是为什么天文学中“视星等”采用对数进行定义！</p></blockquote><p>红线为 Stevens&rsquo; Power Law，满足：</p><p>$$
S = kI^a
$$</p><p>具体哪一种曲线更符合人眼的真实情况不在本文的讨论之列，有兴趣的话可参考<a href=https://www.telescope-optics.net/eye_intensity_response.htm>这篇文章</a>。</p><p>从上面的讨论我们知道了，人眼对光照强度的响应呈现对数关系。也就是说，如果我们随时间线性提高光源的物理亮度，那么在人眼看来，光源的亮度的增速实际上是先快后慢的，看起来并不够平滑。</p><p>如果我们希望人眼感知到的亮度是随时间线性增加的，那显然就需要换一种方法来调整光源的物理亮度，考虑到对数函数的反函数是指数函数，只需要使用指数方式，先慢后快的提高光源物理亮度，就有希望达到上述目的，这可能就是上述 Lut 采用指数函数的原因。</p><p>实际上，如果我们把感知亮度作为横轴，光源真实亮度作为纵轴，就可以得到这样一条曲线：</p><p><img alt="Perceived Light vs. Measured Light" loading=lazy src=/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B05-pwm%E5%91%BC%E5%90%B8%E7%81%AF/img/PerceivedLight.svg#center></p><blockquote><p>Human factors studies have shown that the eye perceives light in a logarithmic manner, mathematically speaking, in an approximately squared power relationship. Figure 1 illustrates this relationship.</p><p>A linear profile is the most intuitive since when the dimming control is set to 50% or at 50% of its slider range then the measured light level is at 50%. However, with a linear profile the changes in light level at the low end of the dimming range are quite large and are sometimes viewed as step changes instead of smooth changes. This is due to the fact that the eye response is logarithmic and these step changes are perceived as being even larger than the measured percentages are. That being said, linear dimming profiles are adequate for many lighting applications that simply require dimming to be used for adjusting the light level for various tasks and times of day. In these applications the light level is adjusted occasionally and left at this level for a long period of time. These applications actually comprise a majority of dimming requirements.</p><p>The best simulation of the eye response is achieved with a logarithmic dimming profile. Figure 1 shows the typical eye response curve but slightly different logarithmic profiles are used by various LED driver manufacturers to enhance dimming performance. In addition to mimicking the eye response better, a logarithmic dimming profile enhances dimming smoothness at the lowest dimming levels. With the advent of the latest LED drivers that can achieve dimming to levels of nearly 0%, the availability of a logarithmic profile becomes even more important. Logarithmic profiles are also valuable for high- lumen-output luminaires (5000 lumens and above) in that they enable the dimming performance to be smoother because of the inherently wide lumen range of the light fixture. Applications requiring artistically ulta-smooth dimming such as theaters will greatly benefit from using logarithmic dimming profiles in all lumen ranges.</p><p>— <cite>Linear vs. Logarithmic Dimming — A White Paper<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></cite></p></blockquote><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.pathwaylighting.com/products/downloads/brochure/technical_materials_1466797044_Linear+vs+Logarithmic+Dimming+White+Paper.pdf>Linear vs. Logarithmic Dimming — A White Paper</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangyuyang.me/tags/c/>C</a></li><li><a href=https://wangyuyang.me/tags/efr32/>EFR32</a></li></ul><nav class=paginav><a class=prev href=https://wangyuyang.me/posts/%E9%B2%9C%E5%88%87%E8%8A%B1%E6%B0%B4%E5%9F%B9%E8%AE%B0%E5%BD%95/><span class=title>« Prev</span><br><span>鲜切花水培记录</span>
</a><a class=next href=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B04-iadc%E9%87%87%E6%A0%B7/><span class=title>Next »</span><br><span>EFR32 入门笔记 4: IADC 采样</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangyuyang.me/>Yuyang Wang's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>