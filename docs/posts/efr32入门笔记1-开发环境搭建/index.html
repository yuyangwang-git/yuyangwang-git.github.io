<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>EFR32 入门笔记 1: 开发环境搭建 | Yuyang Wang's Blog</title><meta name=keywords content="C,EFR32"><meta name=description content="基于 EFR32BG22C112F352GM32"><meta name=author content><link rel=canonical href=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PG166B7MZ2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PG166B7MZ2",{anonymize_ip:!1})}</script><meta property="og:title" content="EFR32 入门笔记 1: 开发环境搭建"><meta property="og:description" content="基于 EFR32BG22C112F352GM32"><meta property="og:type" content="article"><meta property="og:url" content="https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><meta property="og:image" content="https://wangyuyang.me/img/cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-09T10:18:38+08:00"><meta property="article:modified_time" content="2023-03-09T10:18:38+08:00"><meta property="og:site_name" content="Yuyang Wang's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wangyuyang.me/img/cover.jpg"><meta name=twitter:title content="EFR32 入门笔记 1: 开发环境搭建"><meta name=twitter:description content="基于 EFR32BG22C112F352GM32"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://wangyuyang.me/posts/"},{"@type":"ListItem","position":3,"name":"EFR32 入门笔记 1: 开发环境搭建","item":"https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"EFR32 入门笔记 1: 开发环境搭建","name":"EFR32 入门笔记 1: 开发环境搭建","description":"基于 EFR32BG22C112F352GM32","keywords":["C","EFR32"],"articleBody":"预备知识 预备知识 1: EFR32 系列芯片编号规则 EFR32 Family:\nM: Mighty (EFR32MG)\nB: Blue (EFR32BG)\nF: Flex (EFR32FG)\n根据 Family 选择对应的 API 即可，如 EFR32BG22 应查阅文档 Blue Gecko。\n预备知识 2：什么是 Gecko SDK？ Gecko SDK（GSDK）是 Silicon Labs 为该司生产的 MCU 所提供的一系列 SDK 的统称。GSDK 中包含了若干具有不同功能的子 SDK，Github Release 里可以看到详细的内容，包括但不限于：Bluetooth SDK，Zigbee EmberZNet SDK 等等。\n开发工具链 初学就按照官方建议，使用 Simplicity Studio 就好了，Simplicity Studio 5 User’s Guide 里给出了 Step-by-step 的安装说明。\n安装完成后，在 Simplicity Studio 中打开 Installation Manager，选择安装 Gecko SDK 即完成了环境配置。\n创建并编译第一个程序 使用 Simplicity Studio 中的 Silicon Labs Project Wizard 创建第一个 Project，由于我采用的是非官方开发板，因此 Target Boards 栏直接留空，输入 MCU 的型号 EFR32BG22C112F352GM32，并选择 Gecko SDK 即可。\n点击下一步，直接选择 Empty C Project 模板来创建第一个程序。\n如果希望使用 VSCode 打开项目，宜勾选 With project files 中的 Copy contents 而不是默认的 Link sdk and copy project sources，否则会提示找不到部分头文件。\n创建完成后，先点击 Project Explorer 里的项目名称，再点击编译按钮，如果环境配置没有问题，项目将被成功编译。\n0 errors, 0 warnings!\nGecko SDK 的编程模型 前面创建好的项目里除 SDK，还包含了三个文件：main.c，app.c，app.h。\nEmpty C Project 并不是真的 Empty\n这就涉及到了 Gecko SDK 的 Programming Model，可以参考官方文档对这一部分的介绍，这里简单介绍一下：\n#include \"sl_component_catalog.h\" #include \"sl_system_init.h\" #include \"app.h\" #if defined(SL_CATALOG_POWER_MANAGER_PRESENT) #include \"sl_power_manager.h\" #endif #if defined(SL_CATALOG_KERNEL_PRESENT) #include \"sl_system_kernel.h\" #else // SL_CATALOG_KERNEL_PRESENT #include \"sl_system_process_action.h\" #endif // SL_CATALOG_KERNEL_PRESENT int main(void) { // Initialize Silicon Labs device, system, service(s) and protocol stack(s). // Note that if the kernel is present, processing task(s) will be created by // this call. sl_system_init(); // Initialize the application. For example, create periodic timer(s) or // task(s) if the kernel is present. app_init(); #if defined(SL_CATALOG_KERNEL_PRESENT) // Start the kernel. Task(s) created in app_init() will start running. sl_system_kernel_start(); #else // SL_CATALOG_KERNEL_PRESENT while (1) { // Do not remove this call: Silicon Labs components process action routine // must be called from the super loop. sl_system_process_action(); // Application process. app_process_action(); #if defined(SL_CATALOG_POWER_MANAGER_PRESENT) // Let the CPU go to sleep if the system allows it. sl_power_manager_sleep(); #endif } #endif // SL_CATALOG_KERNEL_PRESENT } 可以看到 main.c 里将根据两个宏来实现条件编译：\nSL_CATALOG_POWER_MANAGER_PRESENT SL_CATALOG_KERNEL_PRESENT SL_CATALOG_POWER_MANAGER_PRESENT 宏与芯片的内部的低功耗模式密切相关。如图所示，EFR32BG22 具有四种不同的电源模式：EM0、EM1、EM2、EM3、EM4，利用 Gecko SDK 提供的 Power Manager 可以切换当前的电源模式，这里暂且略过，详细内容可参考官方文档。\nSL_CATALOG_KERNEL_PRESENT 宏决定了项目是否使用 RTOS。默认未定义该宏，即默认采用裸机编程，实际编译的代码为：\n#include \"sl_component_catalog.h\" #include \"sl_system_init.h\" #include \"app.h\" #include \"sl_system_process_action.h\" int main(void) { sl_system_init(); app_init(); while (1) { // Do not remove this call: Silicon Labs components process action routine // must be called from the super loop. sl_system_process_action(); // Application process. app_process_action(); } } 这里的 app_init() 和 app_process_action() 就相当于 Arduino 中的 setup() 和 loop() 函数，也就是说用户程序直接写在 app.c 和 app.h 里就行。\n如果需要使用 RTOS，就应当在 sl_component_catalog.h 中填入#define SL_CATALOG_KERNEL_PRESENT：\n#ifndef SL_COMPONENT_CATALOG_H #define SL_COMPONENT_CATALOG_H // APIs present in project #define SL_CATALOG_DEVICE_INIT_NVIC_PRESENT #define SL_CATALOG_EMLIB_CORE_PRESENT #define SL_CATALOG_EMLIB_CORE_DEBUG_CONFIG_PRESENT #define SL_CATALOG_KERNEL_PRESENT #endif // SL_COMPONENT_CATALOG_H 此时编译的代码为：\n#include \"sl_component_catalog.h\" #include \"sl_system_init.h\" #include \"app.h\" #include \"sl_system_kernel.h\" int main(void) { sl_system_init(); app_init(); // Start the kernel. Task(s) created in app_init() will start running. sl_system_kernel_start(); } 使用 VSCode 编辑程序 主要是 c_cpp_properties.json 文件的修改，待更。\n烧录程序时遇到的问题 将设备通过 SWD 接口连接到 J-Link （笔者使用的是 J-Link v11），安装 J-Link 驱动后，使用 Simplicity Commander 时提示：\nWARNING: Could not connect to target device 于是打开 J-Link Commander，输入 connect，发现还是无法连接：\n- Iterating through AP map to find AHB-AP to use ...... ...... ...... - ERROR: Failed to connect. Could not establish a connection to target. 接着查阅官网资料，官方论坛建议在命令行中执行：\n# Simplicity Studio 的安装目录 $ cd 'D:\\Program Files\\SiliconLabs\\SimplicityStudio\\v5\\developer\\adapter_packs\\commander' # --device 后指定芯片型号 $ .\\commander device recover --device=EFR32BG22C112F352GM32 随后得到了：\nRecovering \"bricked\" device... Resetting device... Attempting to connect to DCI... Success after 1 attempts (6 ms) Running device erase command... Success after 1 attempts (74 ms) Resetting device... Device recovery successful. DONE 此时就可以使用 Simplicity Commander 烧录程序了。\n","wordCount":"506","inLanguage":"en","image":"https://wangyuyang.me/img/cover.jpg","datePublished":"2023-03-09T10:18:38+08:00","dateModified":"2023-03-09T10:18:38+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"},"publisher":{"@type":"Organization","name":"Yuyang Wang's Blog","logo":{"@type":"ImageObject","url":"https://wangyuyang.me/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangyuyang.me accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangyuyang.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://wangyuyang.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://example.org title=Server><span>Server</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wangyuyang.me>Home</a>&nbsp;»&nbsp;<a href=https://wangyuyang.me/posts/>Posts</a></div><h1 class=post-title>EFR32 入门笔记 1: 开发环境搭建</h1><div class=post-description>基于 EFR32BG22C112F352GM32</div><div class=post-meta><span title='2023-03-09 10:18:38 +0800 CST'>March 9, 2023</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;506 words</div></header><figure class=entry-cover><img loading=lazy srcset="https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/img/cover_hub7e7c38a45f1f7be632de198a49cd34a_104628_360x0_resize_q75_box.jpg 360w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/img/cover_hub7e7c38a45f1f7be632de198a49cd34a_104628_480x0_resize_q75_box.jpg 480w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/img/cover_hub7e7c38a45f1f7be632de198a49cd34a_104628_720x0_resize_q75_box.jpg 720w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/img/cover_hub7e7c38a45f1f7be632de198a49cd34a_104628_1080x0_resize_q75_box.jpg 1080w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/img/cover_hub7e7c38a45f1f7be632de198a49cd34a_104628_1500x0_resize_q75_box.jpg 1500w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/img/cover.jpg 1920w" sizes="(min-width: 768px) 720px, 100vw" src=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B01-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/img/cover.jpg alt width=1920 height=1272></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#预备知识>预备知识</a><ul><li><a href=#预备知识-1-efr32-系列芯片编号规则>预备知识 1: EFR32 系列芯片编号规则</a></li><li><a href=#预备知识-2什么是-gecko-sdk>预备知识 2：什么是 Gecko SDK？</a></li></ul></li><li><a href=#开发工具链>开发工具链</a><ul><li><a href=#创建并编译第一个程序>创建并编译第一个程序</a></li><li><a href=#gecko-sdk-的编程模型>Gecko SDK 的编程模型</a></li></ul></li><li><a href=#使用-vscode-编辑程序>使用 VSCode 编辑程序</a></li><li><a href=#烧录程序时遇到的问题>烧录程序时遇到的问题</a></li></ul></nav></div></details></div><div class=post-content><h2 id=预备知识>预备知识<a hidden class=anchor aria-hidden=true href=#预备知识>#</a></h2><h3 id=预备知识-1-efr32-系列芯片编号规则>预备知识 1: EFR32 系列芯片编号规则<a hidden class=anchor aria-hidden=true href=#预备知识-1-efr32-系列芯片编号规则>#</a></h3><p><img loading=lazy src=img/OrderingCodeKey.svg#center alt="Ordering Code Key"></p><blockquote><p>EFR32 Family:</p><p>M: Mighty (EFR32MG)</p><p>B: Blue (EFR32BG)</p><p>F: Flex (EFR32FG)</p></blockquote><p>根据 Family 选择对应的 API 即可，如 EFR32BG22 应查阅文档 Blue Gecko。</p><h3 id=预备知识-2什么是-gecko-sdk>预备知识 2：什么是 Gecko SDK？<a hidden class=anchor aria-hidden=true href=#预备知识-2什么是-gecko-sdk>#</a></h3><p>Gecko SDK（GSDK）是 Silicon Labs 为该司生产的 MCU 所提供的一系列 SDK 的统称。GSDK 中包含了若干具有不同功能的子 SDK，<a href=https://github.com/SiliconLabs/gecko_sdk/releases>Github Release</a> 里可以看到详细的内容，包括但不限于：<code>Bluetooth SDK</code>，<code>Zigbee EmberZNet SDK</code> 等等。</p><h2 id=开发工具链>开发工具链<a hidden class=anchor aria-hidden=true href=#开发工具链>#</a></h2><p>初学就按照官方建议，使用 <a href=https://www.silabs.com/developers/simplicity-studio>Simplicity Studio</a> 就好了，<a href=https://docs.silabs.com/simplicity-studio-5-users-guide/latest/ss-5-users-guide-getting-started/install-ss-5-and-software>Simplicity Studio 5 User’s Guide</a> 里给出了 Step-by-step 的安装说明。</p><p>安装完成后，在 Simplicity Studio 中打开 Installation Manager，选择安装 Gecko SDK 即完成了环境配置。</p><h3 id=创建并编译第一个程序>创建并编译第一个程序<a hidden class=anchor aria-hidden=true href=#创建并编译第一个程序>#</a></h3><p>使用 Simplicity Studio 中的 <code>Silicon Labs Project Wizard</code> 创建第一个 Project，由于我采用的是非官方开发板，因此 Target Boards 栏直接留空，输入 MCU 的型号 <code>EFR32BG22C112F352GM32</code>，并选择 Gecko SDK 即可。</p><p><img loading=lazy src=img/NewProjectWizard.png#center alt=NewProjectWizard></p><p>点击下一步，直接选择 <code>Empty C Project</code> 模板来创建第一个程序。</p><blockquote><p>如果希望使用 VSCode 打开项目，宜勾选 <code>With project files</code> 中的 <code>Copy contents</code> 而不是默认的 <code>Link sdk and copy project sources</code>，否则会提示找不到部分头文件。</p></blockquote><p>创建完成后，先点击 Project Explorer 里的项目名称，再点击编译按钮，如果环境配置没有问题，项目将被成功编译。</p><blockquote><p>0 errors, 0 warnings!</p></blockquote><h3 id=gecko-sdk-的编程模型>Gecko SDK 的编程模型<a hidden class=anchor aria-hidden=true href=#gecko-sdk-的编程模型>#</a></h3><p>前面创建好的项目里除 SDK，还包含了三个文件：<code>main.c</code>，<code>app.c</code>，<code>app.h</code>。</p><blockquote><p>Empty C Project 并不是真的 Empty</p></blockquote><p>这就涉及到了 Gecko SDK 的 Programming Model，可以参考<a href=https://docs.silabs.com/gecko-platform/latest/sdk-programming-model>官方文档</a>对这一部分的介绍，这里简单介绍一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_component_catalog.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_system_init.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;app.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#if defined(SL_CATALOG_POWER_MANAGER_PRESENT)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_power_manager.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e>#if defined(SL_CATALOG_KERNEL_PRESENT)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_system_kernel.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#else </span><span style=color:#75715e>// SL_CATALOG_KERNEL_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_system_process_action.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif </span><span style=color:#75715e>// SL_CATALOG_KERNEL_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Initialize Silicon Labs device, system, service(s) and protocol stack(s).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Note that if the kernel is present, processing task(s) will be created by
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// this call.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>sl_system_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Initialize the application. For example, create periodic timer(s) or
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// task(s) if the kernel is present.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>app_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if defined(SL_CATALOG_KERNEL_PRESENT)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Start the kernel. Task(s) created in app_init() will start running.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>sl_system_kernel_start</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>#else </span><span style=color:#75715e>// SL_CATALOG_KERNEL_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Do not remove this call: Silicon Labs components process action routine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// must be called from the super loop.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sl_system_process_action</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Application process.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>app_process_action</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if defined(SL_CATALOG_POWER_MANAGER_PRESENT)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Let the CPU go to sleep if the system allows it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sl_power_manager_sleep</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span><span style=color:#75715e>#endif </span><span style=color:#75715e>// SL_CATALOG_KERNEL_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>可以看到 <code>main.c</code> 里将根据两个宏来实现条件编译：</p><ul><li>SL_CATALOG_POWER_MANAGER_PRESENT</li><li>SL_CATALOG_KERNEL_PRESENT</li></ul><p><code>SL_CATALOG_POWER_MANAGER_PRESENT</code> 宏与芯片的内部的低功耗模式密切相关。如图所示，EFR32BG22 具有四种不同的电源模式：<code>EM0</code>、<code>EM1</code>、<code>EM2</code>、<code>EM3</code>、<code>EM4</code>，利用 Gecko SDK 提供的 Power Manager 可以切换当前的电源模式，这里暂且略过，详细内容可参考<a href=https://docs.silabs.com/gecko-platform/latest/service/power_manager/overview>官方文档</a>。</p><p><img loading=lazy src=img/EFR32BlockDiagram.svg#center alt=EFR32BlockDiagram></p><p><code>SL_CATALOG_KERNEL_PRESENT</code> 宏决定了项目是否使用 RTOS。默认未定义该宏，即默认采用裸机编程，实际编译的代码为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_component_catalog.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_system_init.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;app.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_system_process_action.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sl_system_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>app_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Do not remove this call: Silicon Labs components process action routine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// must be called from the super loop.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sl_system_process_action</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Application process.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>app_process_action</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里的 <code>app_init()</code> 和 <code>app_process_action()</code> 就相当于 Arduino 中的 <code>setup()</code> 和 <code>loop()</code> 函数，也就是说用户程序直接写在 <code>app.c</code> 和 <code>app.h</code> 里就行。</p><p>如果需要使用 RTOS，就应当在 <code>sl_component_catalog.h</code> 中填入<code>#define SL_CATALOG_KERNEL_PRESENT</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#ifndef SL_COMPONENT_CATALOG_H
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define SL_COMPONENT_CATALOG_H
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// APIs present in project
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SL_CATALOG_DEVICE_INIT_NVIC_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define SL_CATALOG_EMLIB_CORE_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define SL_CATALOG_EMLIB_CORE_DEBUG_CONFIG_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define SL_CATALOG_KERNEL_PRESENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif </span><span style=color:#75715e>// SL_COMPONENT_CATALOG_H
</span></span></span></code></pre></div><p>此时编译的代码为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_component_catalog.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_system_init.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;app.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_system_kernel.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sl_system_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>app_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Start the kernel. Task(s) created in app_init() will start running.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>sl_system_kernel_start</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=使用-vscode-编辑程序>使用 VSCode 编辑程序<a hidden class=anchor aria-hidden=true href=#使用-vscode-编辑程序>#</a></h2><p>主要是 <code>c_cpp_properties.json</code> 文件的修改，待更。</p><h2 id=烧录程序时遇到的问题>烧录程序时遇到的问题<a hidden class=anchor aria-hidden=true href=#烧录程序时遇到的问题>#</a></h2><p>将设备通过 SWD 接口连接到 J-Link （笔者使用的是 J-Link v11），安装 J-Link 驱动后，使用 Simplicity Commander 时提示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>WARNING: Could not connect to target device
</span></span></code></pre></div><p>于是打开 J-Link Commander，输入 connect，发现还是无法连接：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>- Iterating through AP map to find AHB-AP to use
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>- ERROR: Failed to connect.
</span></span><span style=display:flex><span>Could not establish a connection to target.
</span></span></code></pre></div><p>接着查阅官网资料，官方论坛建议在命令行中执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Simplicity Studio 的安装目录</span>
</span></span><span style=display:flex><span>$ cd <span style=color:#e6db74>&#39;D:\Program Files\SiliconLabs\SimplicityStudio\v5\developer\adapter_packs\commander&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --device 后指定芯片型号</span>
</span></span><span style=display:flex><span>$ .<span style=color:#ae81ff>\c</span>ommander device recover --device<span style=color:#f92672>=</span>EFR32BG22C112F352GM32
</span></span></code></pre></div><p>随后得到了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Recovering <span style=color:#e6db74>&#34;bricked&#34;</span> device...
</span></span><span style=display:flex><span>Resetting device...
</span></span><span style=display:flex><span>Attempting to connect to DCI...
</span></span><span style=display:flex><span>Success after <span style=color:#ae81ff>1</span> attempts <span style=color:#f92672>(</span><span style=color:#ae81ff>6</span> ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Running device erase command...
</span></span><span style=display:flex><span>Success after <span style=color:#ae81ff>1</span> attempts <span style=color:#f92672>(</span><span style=color:#ae81ff>74</span> ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Resetting device...
</span></span><span style=display:flex><span>Device recovery successful.
</span></span><span style=display:flex><span>DONE
</span></span></code></pre></div><p>此时就可以使用 Simplicity Commander 烧录程序了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangyuyang.me/tags/c/>C</a></li><li><a href=https://wangyuyang.me/tags/efr32/>EFR32</a></li></ul><nav class=paginav><a class=prev href=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B02-%E7%82%B9%E4%BA%AEled%E7%81%AF/><span class=title>« Prev</span><br><span>EFR32 入门笔记 2: 点亮 LED 灯</span></a>
<a class=next href=https://wangyuyang.me/posts/2023%E5%B9%B4%E5%BA%A6%E8%AE%A1%E5%88%92/><span class=title>Next »</span><br><span>近几年的计划</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://wangyuyang.me>Yuyang Wang's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>