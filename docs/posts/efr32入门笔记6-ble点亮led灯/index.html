<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>EFR32 入门笔记 6: BLE 点亮 LED 灯 | Yuyang Wang's Blog</title><meta name=keywords content="C,EFR32"><meta name=description content="过去没接触过蓝牙开发，硬啃蓝牙协议啃了好久"><meta name=author content><link rel=canonical href=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wangyuyang.me/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PG166B7MZ2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PG166B7MZ2",{anonymize_ip:!1})}</script><meta property="og:title" content="EFR32 入门笔记 6: BLE 点亮 LED 灯"><meta property="og:description" content="过去没接触过蓝牙开发，硬啃蓝牙协议啃了好久"><meta property="og:type" content="article"><meta property="og:url" content="https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/"><meta property="og:image" content="https://wangyuyang.me/img/cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-01T23:25:48+08:00"><meta property="article:modified_time" content="2023-04-01T23:25:48+08:00"><meta property="og:site_name" content="Yuyang Wang's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wangyuyang.me/img/cover.jpg"><meta name=twitter:title content="EFR32 入门笔记 6: BLE 点亮 LED 灯"><meta name=twitter:description content="过去没接触过蓝牙开发，硬啃蓝牙协议啃了好久"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://wangyuyang.me/posts/"},{"@type":"ListItem","position":3,"name":"EFR32 入门笔记 6: BLE 点亮 LED 灯","item":"https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"EFR32 入门笔记 6: BLE 点亮 LED 灯","name":"EFR32 入门笔记 6: BLE 点亮 LED 灯","description":"过去没接触过蓝牙开发，硬啃蓝牙协议啃了好久","keywords":["C","EFR32"],"articleBody":"背景知识 整个蓝牙协议栈内容太多了，以后如果有时间单独写几篇相关文章梳理一下，本文将直接上手写程序。\n利用 Bluetooth LE 点亮 LED 灯 最终目标：利用智能手机远程控制（开启及关闭） EFR32BG22 IO 口连接的 LED 灯。\n上述 EFR32BG22 将运行在 Standalone mode。\n预先准备 手机上需要安装蓝牙调试程序，常用的调试软件有：\nnRF Connect LightBlue EFR Connect 三个软件的功能完全重合。每个都试了一下，感觉在 iOS 上做的最完善的还是 Nordic Semiconductor 的 nRF Connect。\n这何尝不是一种 NTR？\n创建 Project 首先，基于 Bluetooth - SoC Empty 模板创建一个空蓝牙项目，命名为 bluetooth_led_blink：\n随后，安装 Services - I/O: stream USART 并创建 instance；安装 Application - Utility: Log，卸载 Platform - RAIL Utility, PTI，完成后就可以写应用相关代码了。\n为什么要卸载 PTI Components？\nPacket Trace Interface 是一个用于调试 network activity 的组件，我们暂时用不到这个功能，当然也可以不卸载，但不卸载的话会，编译后在 Simplicity IDE 底部的 Problems 中出现一条报错消息：\nErrors (1 item): ERROR: DOUT is not defined - DOUT is required when PTI enabled, please select pin for DOUT 虽然不影响最后生成 .hex 文件，但是显然让人看着心烦，不如直接删了。\n修改 GATT 在正式编写程序之前，还需要修改 Generic Attribute Profile (GATT)，\n打开 bluetooth_led_blink.slcp，切换到 Configuration Tools Tab，随后打开 Bluetooth GATT Configurator：\n修改 Device Name 为 LED Controller，后面我们使用手机搜索蓝牙设备时，看到的名称就是这里填写的 Device Name。\nDevice Information 里都是一些“无关紧要的”设备信息，包括制造商名称，产品序列号，版本号等，这里就不修改了，不影响点灯。\n接下来就是最重要的部分，在 GATT 中增加一个 Service，该 Service 包含一个控制 LED 开关的 Characteristics 字段：\n这里 Characteristic Name 其实无所谓，重要的是 ID （将影响我们的程序中的变量名），Value Settings（将决定手机和芯片通信时传输的数据类型） 和 Properties （将决定其他设备是否有权限读取和修改该字段，换句话说，手机是否有权限控制灯的打开和关闭）。另外，记下这里的 UUID。\n完成修改后保存该文件。\n修改程序 最后就是程序部分了，先来简单过一遍初始文件模板。\n// app.c #include \"em_common.h\" #include \"app_assert.h\" #include \"sl_bluetooth.h\" #include \"app.h\" // The advertising set handle allocated from Bluetooth stack. static uint8_t advertising_set_handle = 0xff; /**************************************************************************//** * Application Init. *****************************************************************************/ SL_WEAK void app_init(void) { ///////////////////////////////////////////////////////////////////////////// // Put your additional application init code here! // // This is called once during start-up. // ///////////////////////////////////////////////////////////////////////////// } /**************************************************************************//** * Application Process Action. *****************************************************************************/ SL_WEAK void app_process_action(void) { ///////////////////////////////////////////////////////////////////////////// // Put your additional application code here! // // This is called infinitely. // // Do not call blocking functions from here! // ///////////////////////////////////////////////////////////////////////////// } /**************************************************************************//** * Bluetooth stack event handler. * This overrides the dummy weak implementation. * * @param[in] evt Event coming from the Bluetooth stack. *****************************************************************************/ void sl_bt_on_event(sl_bt_msg_t *evt) { sl_status_t sc; switch (SL_BT_MSG_ID(evt-\u003eheader)) { // ------------------------------- // This event indicates the device has started and the radio is ready. // Do not call any stack command before receiving this boot event! case sl_bt_evt_system_boot_id: // Create an advertising set. sc = sl_bt_advertiser_create_set(\u0026advertising_set_handle); app_assert_status(sc); // Generate data for advertising sc = sl_bt_legacy_advertiser_generate_data(advertising_set_handle, sl_bt_advertiser_general_discoverable); app_assert_status(sc); // Set advertising interval to 100ms. sc = sl_bt_advertiser_set_timing( advertising_set_handle, 160, // min. adv. interval (milliseconds * 1.6) 160, // max. adv. interval (milliseconds * 1.6) 0, // adv. duration 0); // max. num. adv. events app_assert_status(sc); // Start advertising and enable connections. sc = sl_bt_legacy_advertiser_start(advertising_set_handle, sl_bt_advertiser_connectable_scannable); app_assert_status(sc); break; // ------------------------------- // This event indicates that a new connection was opened. case sl_bt_evt_connection_opened_id: break; // ------------------------------- // This event indicates that a connection was closed. case sl_bt_evt_connection_closed_id: // Generate data for advertising sc = sl_bt_legacy_advertiser_generate_data(advertising_set_handle, sl_bt_advertiser_general_discoverable); app_assert_status(sc); // Restart advertising after client has disconnected. sc = sl_bt_legacy_advertiser_start(advertising_set_handle, sl_bt_advertiser_connectable_scannable); app_assert_status(sc); break; /////////////////////////////////////////////////////////////////////////// // Add additional event handlers here as your application requires! // /////////////////////////////////////////////////////////////////////////// // ------------------------------- // Default event handler. default: break; } } 其实文件里就是三个函数：\nSL_WEAK void app_init(void) SL_WEAK void app_process_action(void) void sl_bt_on_event(sl_bt_msg_t *evt) app_init() 和 app_process_action() 都是老熟人了，至于它们为什么被 SL_WEAK 关键字修饰，这里暂且先不用管，只要把我们应用代码放到这两个函数里就行。重点是最后一个函数 sl_bt_on_event()，我们删掉一部分内容，简单看一下这个函数的结构：\n/**************************************************************************//** * Bluetooth stack event handler. * This overrides the dummy weak implementation. * * @param[in] evt Event coming from the Bluetooth stack. *****************************************************************************/ void sl_bt_on_event(sl_bt_msg_t *evt) { sl_status_t sc; switch (SL_BT_MSG_ID(evt-\u003eheader)) { // ------------------------------- // This event indicates the device has started and the radio is ready. // Do not call any stack command before receiving this boot event! case sl_bt_evt_system_boot_id: break; // ------------------------------- // This event indicates that a new connection was opened. case sl_bt_evt_connection_opened_id: break; // ------------------------------- // This event indicates that a connection was closed. case sl_bt_evt_connection_closed_id: break; /////////////////////////////////////////////////////////////////////////// // Add additional event handlers here as your application requires! // /////////////////////////////////////////////////////////////////////////// // ------------------------------- // Default event handler. default: break; } 该函数内部就是一个大的 switch...case... 循环，具体执行哪些代码分支，将由传入的参数 evt 决定。当 EFR32 的蓝牙状态发生改变时（如有新的蓝牙设备连接到 EFR32，或者已连接的设备尝试读取或写入数据），sl_bt_on_event() 函数将被自动调用，用户可以在这里增加一个 switch...case... 分支，通过传入的 evt 参数来判断到底是哪一个 bluetooth event 触发了本次调用，并在对应的 case 语句里进行相应的处理。\n其实就是 UI 编程里非常常用的事件驱动模型嘛。\n看到这里自然会产生疑问，我怎么知道有哪些 event 会触发该函数的调用？实际上官方文档里写的非常详细，具体可以查阅文档的 API Reference 部分。\n回到我们的目的上来，在 app.c 中进行如下修改：\n首先，增加对以下几个头文件的引用：\n// 为了控制 GPIO： #include \"em_cmu.h\" #include \"em_gpio.h\" // 为了引用我们在 GATT 中创建的所有内容： #include \"gatt_db.h\" // 为了更方便的打印日志，当然也可以用 printf() 代替： #include \"app_log.h\" 配置 GPIO 初始化：\nSL_WEAK void app_init(void) { CMU_ClockEnable(cmuClock_GPIO, true); // LED 灯连接在 PB02 上, 高电平点亮 GPIO_PinModeSet(gpioPortB, 2, gpioModePushPull, 0); GPIO_PinOutSet(gpioPortB, 2); } 蓝牙事件处理，这里主要针对三个事件进行处理：\nsl_bt_evt_connection_opened_id, 蓝牙连接打开事件 sl_bt_evt_connection_closed_id, 蓝牙连接关闭事件 sl_bt_evt_gatt_server_attribute_value_id, GATT 修改事件，在这里切换 LED 状态 void sl_bt_on_event(sl_bt_msg_t *evt) { sl_status_t sc; switch (SL_BT_MSG_ID(evt-\u003eheader)) { // ------------------------------- // This event indicates the device has started and the radio is ready. // Do not call any stack command before receiving this boot event! case sl_bt_evt_system_boot_id: // Create an advertising set. sc = sl_bt_advertiser_create_set(\u0026advertising_set_handle); app_assert_status(sc); // Generate data for advertising sc = sl_bt_legacy_advertiser_generate_data(advertising_set_handle, sl_bt_advertiser_general_discoverable); app_assert_status(sc); // Set advertising interval to 100ms. sc = sl_bt_advertiser_set_timing( advertising_set_handle, 160, // min. adv. interval (milliseconds * 1.6) 160, // max. adv. interval (milliseconds * 1.6) 0, // adv. duration 0); // max. num. adv. events app_assert_status(sc); // Start advertising and enable connections. sc = sl_bt_legacy_advertiser_start(advertising_set_handle, sl_bt_advertiser_connectable_scannable); app_assert_status(sc); break; // ------------------------------- // This event indicates that a new connection was opened. case sl_bt_evt_connection_opened_id: app_log_info(\"Connection opened.\\n\"); break; // ------------------------------- // This event indicates that a connection was closed. case sl_bt_evt_connection_closed_id: app_log_info(\"Connection closed.\\n\"); // Generate data for advertising sc = sl_bt_legacy_advertiser_generate_data(advertising_set_handle, sl_bt_advertiser_general_discoverable); app_assert_status(sc); // Restart advertising after client has disconnected. sc = sl_bt_legacy_advertiser_start(advertising_set_handle, sl_bt_advertiser_connectable_scannable); app_assert_status(sc); break; // ------------------------------- // This event indicates that the value of an attribute in the local GATT // database was changed by a remote GATT client. case sl_bt_evt_gatt_server_attribute_value_id: // The value of the gattdb_led_status characteristic was changed. if (gattdb_led_status == evt-\u003edata.evt_gatt_server_attribute_value.attribute) { uint8_t data_recv; size_t data_recv_len; // Read characteristic value. sc = sl_bt_gatt_server_read_attribute_value(gattdb_led_status, 0, sizeof(data_recv), \u0026data_recv_len, \u0026data_recv); (void)data_recv_len; app_log_status_error(sc); if (sc != SL_STATUS_OK) { break; } // Toggle LED. if (data_recv == 0x00) { GPIO_PinOutClear(gpioPortB, 2);; app_log_info(\"LED off.\\n\"); } else if (data_recv == 0x01) { GPIO_PinOutSet(gpioPortB, 2);; app_log_info(\"LED on.\\n\"); } else { app_log_error(\"Invalid attribute value: 0x%02x\\n\", (int)data_recv); } } break; /////////////////////////////////////////////////////////////////////////// // Add additional event handlers here as your application requires! // /////////////////////////////////////////////////////////////////////////// // ------------------------------- // Default event handler. default: break; } 到这里编译并烧录其实就可以了，但是我们注意 build console 中的提示信息，会发现存在两条警告：\n../sl_gatt_service_device_information.c: In function 'sl_gatt_service_device_information_on_event': ../sl_gatt_service_device_information.c:63:2: warning: #warning \"Could not set Model Number String.\" [-Wcpp] 63 | #warning \"Could not set Model Number String.\" | ^~~~~~~ ../sl_gatt_service_device_information.c:77:2: warning: #warning \"Could not set Hardware Revision String.\" [-Wcpp] 77 | #warning \"Could not set Hardware Revision String.\" | ^~~~~~~ 为此，打开 sl_gatt_service_device_information.c 文件，定位到报错的 line 63 和 77，可以看到：\n#if defined(gattdb_model_number_string) \u0026\u0026 defined(SL_BOARD_NAME) sc = sl_bt_gatt_server_write_attribute_value(gattdb_model_number_string, 0, GATTDB_MODEL_NUMBER_STRING_LEN, (uint8_t *)SL_BOARD_NAME); app_assert_status(sc); #else #warning \"Could not set Model Number String.\" // Check the presence of this characteristic and the ID reference in the GATT // Configurator. If using a custom board, remove this section and use the // GATT Configurator to set the value manually. #endif // Hardware Revision String #if defined(gattdb_hardware_revision_string) \u0026\u0026 defined(SL_BOARD_REV) sc = sl_bt_gatt_server_write_attribute_value(gattdb_hardware_revision_string, 0, GATTDB_HARDWARE_REVISION_STRING_LEN, (uint8_t *)SL_BOARD_REV); app_assert_status(sc); #else #warning \"Could not set Hardware Revision String.\" // Check the presence of this characteristic and the ID reference in the GATT // Configurator. If using a custom board, remove this section and use the // GATT Configurator to set the value manually. #endif 注释里写的很清楚，如果我们用的不是官方开发板，把这两条 #warning 直接注释掉就行。\n注释后重新编译：\nBuild Finished. 0 errors, 0 warnings. (took 8s.351ms) 2025.06.25 简单说几句，烧录程序时需要特别注意起始地址：\n直接烧录，会发现 MCU 仿佛被冻结，代码没有被正确运行，这是因为默认从 Flash 基地址 0x0000 下载程序，没有启用蓝牙时确实是对的\n启用蓝牙后，由于 bootloader 的原因，Flash 前面几段地址被另作他用，因此用户程序的烧录起始地址需要修改，没记错的话是 0x6000\n测试 PC 端启动串口调试程序。手机端启动 nRF Connect，并搜索附近的设备：\n连接后，切换到 Client Tab，根据前面记下的 UUID，在 Attribute Table 中找到对应的 Characteristics，并点击向上的箭头（其实在我们的程序里，只有这个 Characteristics 开启了 Write 权限，所以只有它有上箭头，看不看 UUID 意义不大）：\n尝试改变写入的值，就可以看到 LED 灯随着我们的操作被点亮和关闭。\n","wordCount":"1159","inLanguage":"en","image":"https://wangyuyang.me/img/cover.jpg","datePublished":"2023-04-01T23:25:48+08:00","dateModified":"2023-04-01T23:25:48+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/"},"publisher":{"@type":"Organization","name":"Yuyang Wang's Blog","logo":{"@type":"ImageObject","url":"https://wangyuyang.me/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangyuyang.me accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wangyuyang.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://wangyuyang.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://example.org title=Server><span>Server</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wangyuyang.me>Home</a>&nbsp;»&nbsp;<a href=https://wangyuyang.me/posts/>Posts</a></div><h1 class=post-title>EFR32 入门笔记 6: BLE 点亮 LED 灯</h1><div class=post-description>过去没接触过蓝牙开发，硬啃蓝牙协议啃了好久</div><div class=post-meta><span title='2023-04-01 23:25:48 +0800 CST'>April 1, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1159 words</div></header><figure class=entry-cover><img loading=lazy srcset="https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/img/cover_hu7895222e9682719b905786c3e4677372_90428_360x0_resize_q75_box.jpg 360w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/img/cover_hu7895222e9682719b905786c3e4677372_90428_480x0_resize_q75_box.jpg 480w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/img/cover_hu7895222e9682719b905786c3e4677372_90428_720x0_resize_q75_box.jpg 720w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/img/cover_hu7895222e9682719b905786c3e4677372_90428_1080x0_resize_q75_box.jpg 1080w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/img/cover_hu7895222e9682719b905786c3e4677372_90428_1500x0_resize_q75_box.jpg 1500w ,https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/img/cover.jpg 1920w" sizes="(min-width: 768px) 720px, 100vw" src=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B06-ble%E7%82%B9%E4%BA%AEled%E7%81%AF/img/cover.jpg alt width=1920 height=1260></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#背景知识>背景知识</a></li><li><a href=#利用-bluetooth-le-点亮-led-灯>利用 Bluetooth LE 点亮 LED 灯</a><ul><li><a href=#预先准备>预先准备</a></li><li><a href=#创建-project>创建 Project</a></li><li><a href=#修改-gatt>修改 GATT</a></li><li><a href=#修改程序>修改程序</a></li><li><a href=#测试>测试</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=背景知识>背景知识<a hidden class=anchor aria-hidden=true href=#背景知识>#</a></h2><p>整个蓝牙协议栈内容太多了，以后如果有时间单独写几篇相关文章梳理一下，本文将直接上手写程序。</p><h2 id=利用-bluetooth-le-点亮-led-灯>利用 Bluetooth LE 点亮 LED 灯<a hidden class=anchor aria-hidden=true href=#利用-bluetooth-le-点亮-led-灯>#</a></h2><p>最终目标：利用智能手机远程控制（开启及关闭） EFR32BG22 IO 口连接的 LED 灯。</p><p>上述 EFR32BG22 将运行在 Standalone mode。</p><h3 id=预先准备>预先准备<a hidden class=anchor aria-hidden=true href=#预先准备>#</a></h3><p>手机上需要安装蓝牙调试程序，常用的调试软件有：</p><ol><li>nRF Connect</li><li>LightBlue</li><li>EFR Connect</li></ol><p><img loading=lazy src=img/bluetooth_tools.jpg#center alt="bluetooth tools"></p><p>三个软件的功能完全重合。每个都试了一下，感觉在 iOS 上做的最完善的还是 Nordic Semiconductor 的 nRF Connect。</p><p><del>这何尝不是一种 NTR？</del></p><h3 id=创建-project>创建 Project<a hidden class=anchor aria-hidden=true href=#创建-project>#</a></h3><p>首先，基于 <code>Bluetooth - SoC Empty</code> 模板创建一个空蓝牙项目，命名为 <code>bluetooth_led_blink</code>：</p><p><img loading=lazy src=img/new_project_wizard.png#center alt="new project wizard"></p><p>随后，安装 <code>Services - I/O: stream USART</code> 并创建 <code>instance</code>；安装 <code>Application - Utility: Log</code>，卸载 <code>Platform - RAIL Utility, PTI</code>，完成后就可以写应用相关代码了。</p><blockquote><p>为什么要卸载 PTI Components？</p><p>Packet Trace Interface 是一个用于调试 network activity 的组件，我们暂时用不到这个功能，当然也可以不卸载，但不卸载的话会，编译后在 Simplicity IDE 底部的 Problems 中出现一条报错消息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>
</span></span><span style=display:flex><span>Errors (1 item): 
</span></span><span style=display:flex><span>ERROR: DOUT is not defined - DOUT is required when PTI enabled, please select pin for DOUT
</span></span></code></pre></div><p><img loading=lazy src=img/pti_problems.png#center alt="pti problems"></p><p>虽然不影响最后生成 <code>.hex</code> 文件，但是显然让人看着心烦，不如直接删了。</p></blockquote><h3 id=修改-gatt>修改 GATT<a hidden class=anchor aria-hidden=true href=#修改-gatt>#</a></h3><p>在正式编写程序之前，还需要修改 Generic Attribute Profile (GATT)，</p><p>打开 <code>bluetooth_led_blink.slcp</code>，切换到 Configuration Tools Tab，随后打开 <code>Bluetooth GATT Configurator</code>：</p><p><img loading=lazy src=img/configuration_tools.png#center alt="configuration tools"></p><p>修改 <code>Device Name</code> 为 <code>LED Controller</code>，后面我们使用手机搜索蓝牙设备时，看到的名称就是这里填写的 <code>Device Name</code>。</p><p><img loading=lazy src=img/bluetooth_gatt_configurator.png#center alt="Bluetooth GATT Configurator"></p><p><code>Device Information</code> 里都是一些“无关紧要的”设备信息，包括制造商名称，产品序列号，版本号等，这里就不修改了，不影响点灯。</p><p>接下来就是最重要的部分，在 GATT 中增加一个 Service，该 Service 包含一个控制 LED 开关的 Characteristics 字段：</p><p><img loading=lazy src=img/led_status.png#center alt="led status"></p><p>这里 <code>Characteristic Name</code> 其实无所谓，重要的是 <code>ID</code> （将影响我们的程序中的变量名），<code>Value Settings</code>（将决定手机和芯片通信时传输的数据类型） 和 <code>Properties</code> （将决定其他设备是否有权限读取和修改该字段，换句话说，手机是否有权限控制灯的打开和关闭）。另外，<strong>记下这里的 UUID</strong>。</p><p>完成修改后保存该文件。</p><h3 id=修改程序>修改程序<a hidden class=anchor aria-hidden=true href=#修改程序>#</a></h3><p>最后就是程序部分了，先来简单过一遍初始文件模板。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// app.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;em_common.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;app_assert.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sl_bluetooth.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;app.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The advertising set handle allocated from Bluetooth stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>uint8_t</span> advertising_set_handle <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xff</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**************************************************************************//**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Application Init.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *****************************************************************************/</span>
</span></span><span style=display:flex><span>SL_WEAK <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>/////////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Put your additional application init code here!                         //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// This is called once during start-up.                                    //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/////////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**************************************************************************//**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Application Process Action.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *****************************************************************************/</span>
</span></span><span style=display:flex><span>SL_WEAK <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_process_action</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>/////////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Put your additional application code here!                              //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// This is called infinitely.                                              //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Do not call blocking functions from here!                               //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/////////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**************************************************************************//**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Bluetooth stack event handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * This overrides the dummy weak implementation.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param[in] evt Event coming from the Bluetooth stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *****************************************************************************/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sl_bt_on_event</span>(<span style=color:#66d9ef>sl_bt_msg_t</span> <span style=color:#f92672>*</span>evt)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>sl_status_t</span> sc;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>SL_BT_MSG_ID</span>(evt<span style=color:#f92672>-&gt;</span>header)) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates the device has started and the radio is ready.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Do not call any stack command before receiving this boot event!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_system_boot_id:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Create an advertising set.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_advertiser_create_set</span>(<span style=color:#f92672>&amp;</span>advertising_set_handle);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate data for advertising
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_generate_data</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                                 sl_bt_advertiser_general_discoverable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Set advertising interval to 100ms.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_advertiser_set_timing</span>(
</span></span><span style=display:flex><span>        advertising_set_handle,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>160</span>, <span style=color:#75715e>// min. adv. interval (milliseconds * 1.6)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#ae81ff>160</span>, <span style=color:#75715e>// max. adv. interval (milliseconds * 1.6)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#ae81ff>0</span>,   <span style=color:#75715e>// adv. duration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#ae81ff>0</span>);  <span style=color:#75715e>// max. num. adv. events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Start advertising and enable connections.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_start</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                         sl_bt_advertiser_connectable_scannable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates that a new connection was opened.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_connection_opened_id:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates that a connection was closed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_connection_closed_id:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate data for advertising
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_generate_data</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                                 sl_bt_advertiser_general_discoverable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Restart advertising after client has disconnected.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_start</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                         sl_bt_advertiser_connectable_scannable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>///////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Add additional event handlers here as your application requires!      //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>///////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Default event handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其实文件里就是三个函数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>SL_WEAK <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SL_WEAK <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_process_action</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sl_bt_on_event</span>(<span style=color:#66d9ef>sl_bt_msg_t</span> <span style=color:#f92672>*</span>evt)
</span></span></code></pre></div><p><code>app_init()</code> 和 <code>app_process_action()</code> 都是老熟人了，至于它们为什么被 <code>SL_WEAK</code> 关键字修饰，这里暂且先不用管，只要把我们应用代码放到这两个函数里就行。重点是最后一个函数 <code>sl_bt_on_event()</code>，我们删掉一部分内容，简单看一下这个函数的结构：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/**************************************************************************//**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Bluetooth stack event handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * This overrides the dummy weak implementation.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param[in] evt Event coming from the Bluetooth stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *****************************************************************************/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sl_bt_on_event</span>(<span style=color:#66d9ef>sl_bt_msg_t</span> <span style=color:#f92672>*</span>evt)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>sl_status_t</span> sc;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>SL_BT_MSG_ID</span>(evt<span style=color:#f92672>-&gt;</span>header)) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates the device has started and the radio is ready.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Do not call any stack command before receiving this boot event!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_system_boot_id:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates that a new connection was opened.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_connection_opened_id:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates that a connection was closed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_connection_closed_id:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>///////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Add additional event handlers here as your application requires!      //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>///////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Default event handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>该函数内部就是一个大的 <code>switch...case...</code> 循环，具体执行哪些代码分支，将由传入的参数 <code>evt</code> 决定。当 EFR32 的蓝牙状态发生改变时（如有新的蓝牙设备连接到 EFR32，或者已连接的设备尝试读取或写入数据），<code>sl_bt_on_event()</code> 函数将被自动调用，用户可以在这里增加一个 <code>switch...case...</code> 分支，通过传入的 <code>evt</code> 参数来判断到底是哪一个 bluetooth event 触发了本次调用，并在对应的 <code>case</code> 语句里进行相应的处理。</p><blockquote><p>其实就是 UI 编程里非常常用的事件驱动模型嘛。</p></blockquote><p>看到这里自然会产生疑问，我怎么知道有哪些 event 会触发该函数的调用？实际上官方文档里写的非常详细，具体可以查阅文档的 <a href=https://docs.silabs.com/bluetooth/5.0/index>API Reference</a> 部分。</p><p>回到我们的目的上来，在 <code>app.c</code> 中进行如下修改：</p><p>首先，增加对以下几个头文件的引用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// 为了控制 GPIO：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;em_cmu.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;em_gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 为了引用我们在 GATT 中创建的所有内容：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;gatt_db.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 为了更方便的打印日志，当然也可以用 printf() 代替：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;app_log.h&#34;</span><span style=color:#75715e>
</span></span></span></code></pre></div><p>配置 GPIO 初始化：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>SL_WEAK <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CMU_ClockEnable</span>(cmuClock_GPIO, true);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// LED 灯连接在 PB02 上, 高电平点亮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>GPIO_PinModeSet</span>(gpioPortB, <span style=color:#ae81ff>2</span>, gpioModePushPull, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>GPIO_PinOutSet</span>(gpioPortB, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>蓝牙事件处理，这里主要针对三个事件进行处理：</p><ul><li><code>sl_bt_evt_connection_opened_id</code>, 蓝牙连接打开事件</li><li><code>sl_bt_evt_connection_closed_id</code>, 蓝牙连接关闭事件</li><li><code>sl_bt_evt_gatt_server_attribute_value_id</code>, GATT 修改事件，在这里切换 LED 状态</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sl_bt_on_event</span>(<span style=color:#66d9ef>sl_bt_msg_t</span> <span style=color:#f92672>*</span>evt)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>sl_status_t</span> sc;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>SL_BT_MSG_ID</span>(evt<span style=color:#f92672>-&gt;</span>header)) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates the device has started and the radio is ready.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Do not call any stack command before receiving this boot event!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_system_boot_id:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Create an advertising set.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_advertiser_create_set</span>(<span style=color:#f92672>&amp;</span>advertising_set_handle);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate data for advertising
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_generate_data</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                                 sl_bt_advertiser_general_discoverable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Set advertising interval to 100ms.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_advertiser_set_timing</span>(
</span></span><span style=display:flex><span>        advertising_set_handle,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>160</span>, <span style=color:#75715e>// min. adv. interval (milliseconds * 1.6)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#ae81ff>160</span>, <span style=color:#75715e>// max. adv. interval (milliseconds * 1.6)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#ae81ff>0</span>,   <span style=color:#75715e>// adv. duration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#ae81ff>0</span>);  <span style=color:#75715e>// max. num. adv. events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Start advertising and enable connections.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_start</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                         sl_bt_advertiser_connectable_scannable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates that a new connection was opened.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_connection_opened_id:
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_log_info</span>(<span style=color:#e6db74>&#34;Connection opened.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates that a connection was closed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_connection_closed_id:
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_log_info</span>(<span style=color:#e6db74>&#34;Connection closed.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate data for advertising
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_generate_data</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                                 sl_bt_advertiser_general_discoverable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Restart advertising after client has disconnected.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_legacy_advertiser_start</span>(advertising_set_handle,
</span></span><span style=display:flex><span>                                         sl_bt_advertiser_connectable_scannable);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This event indicates that the value of an attribute in the local GATT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// database was changed by a remote GATT client.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> sl_bt_evt_gatt_server_attribute_value_id:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// The value of the gattdb_led_status characteristic was changed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (gattdb_led_status <span style=color:#f92672>==</span> evt<span style=color:#f92672>-&gt;</span>data.evt_gatt_server_attribute_value.attribute) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint8_t</span> data_recv;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>size_t</span> data_recv_len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Read characteristic value.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_gatt_server_read_attribute_value</span>(gattdb_led_status,
</span></span><span style=display:flex><span>                                                    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                                                    <span style=color:#66d9ef>sizeof</span>(data_recv),
</span></span><span style=display:flex><span>                                                    <span style=color:#f92672>&amp;</span>data_recv_len,
</span></span><span style=display:flex><span>                                                    <span style=color:#f92672>&amp;</span>data_recv);
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>void</span>)data_recv_len;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app_log_status_error</span>(sc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sc <span style=color:#f92672>!=</span> SL_STATUS_OK) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Toggle LED.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (data_recv <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x00</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>GPIO_PinOutClear</span>(gpioPortB, <span style=color:#ae81ff>2</span>);;
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>app_log_info</span>(<span style=color:#e6db74>&#34;LED off.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (data_recv <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x01</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>GPIO_PinOutSet</span>(gpioPortB, <span style=color:#ae81ff>2</span>);;
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>app_log_info</span>(<span style=color:#e6db74>&#34;LED on.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>app_log_error</span>(<span style=color:#e6db74>&#34;Invalid attribute value: 0x%02x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, (<span style=color:#66d9ef>int</span>)data_recv);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>///////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Add additional event handlers here as your application requires!      //
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>///////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Default event handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>到这里编译并烧录其实就可以了，但是我们注意 build console 中的提示信息，会发现存在两条警告：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>../sl_gatt_service_device_information.c: In function &#39;sl_gatt_service_device_information_on_event&#39;:
</span></span><span style=display:flex><span>../sl_gatt_service_device_information.c:63:2: warning: #warning &#34;Could not set Model Number String.&#34; [-Wcpp]
</span></span><span style=display:flex><span>   63 | #warning &#34;Could not set Model Number String.&#34;
</span></span><span style=display:flex><span>      |  ^~~~~~~
</span></span><span style=display:flex><span>../sl_gatt_service_device_information.c:77:2: warning: #warning &#34;Could not set Hardware Revision String.&#34; [-Wcpp]
</span></span><span style=display:flex><span>   77 | #warning &#34;Could not set Hardware Revision String.&#34;
</span></span><span style=display:flex><span>      |  ^~~~~~~
</span></span></code></pre></div><p>为此，打开 <code>sl_gatt_service_device_information.c</code> 文件，定位到报错的 line 63 和 77，可以看到：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#if defined(gattdb_model_number_string) &amp;&amp; defined(SL_BOARD_NAME)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_gatt_server_write_attribute_value</span>(gattdb_model_number_string,
</span></span><span style=display:flex><span>                                                   <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                                                   GATTDB_MODEL_NUMBER_STRING_LEN,
</span></span><span style=display:flex><span>                                                   (<span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>)SL_BOARD_NAME);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e>#warning &#34;Could not set Model Number String.&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// Check the presence of this characteristic and the ID reference in the GATT
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Configurator. If using a custom board, remove this section and use the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// GATT Configurator to set the value manually.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Hardware Revision String
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#if defined(gattdb_hardware_revision_string) &amp;&amp; defined(SL_BOARD_REV)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      sc <span style=color:#f92672>=</span> <span style=color:#a6e22e>sl_bt_gatt_server_write_attribute_value</span>(gattdb_hardware_revision_string,
</span></span><span style=display:flex><span>                                                   <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                                                   GATTDB_HARDWARE_REVISION_STRING_LEN,
</span></span><span style=display:flex><span>                                                   (<span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>)SL_BOARD_REV);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app_assert_status</span>(sc);
</span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e>#warning &#34;Could not set Hardware Revision String.&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// Check the presence of this characteristic and the ID reference in the GATT
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Configurator. If using a custom board, remove this section and use the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// GATT Configurator to set the value manually.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><p>注释里写的很清楚，如果我们用的不是官方开发板，把这两条 <code>#warning</code> 直接注释掉就行。</p><p>注释后重新编译：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Build Finished. 0 errors, 0 warnings. (took 8s.351ms)
</span></span></code></pre></div><p><img loading=lazy src=img/0_error_0_warning.jpg#center alt="0 error 0 warning"></p><blockquote><p><em>2025.06.25</em> 简单说几句，烧录程序时需要特别注意起始地址：</p><p>直接烧录，会发现 MCU 仿佛被冻结，代码没有被正确运行，这是因为默认从 Flash 基地址 0x0000 下载程序，没有启用蓝牙时确实是对的</p><p>启用蓝牙后，由于 bootloader 的原因，Flash 前面几段地址被另作他用，因此用户程序的烧录起始地址需要修改，没记错的话是 0x6000</p></blockquote><h3 id=测试>测试<a hidden class=anchor aria-hidden=true href=#测试>#</a></h3><p>PC 端启动串口调试程序。手机端启动 nRF Connect，并搜索附近的设备：</p><p><img loading=lazy src=img/nrf_connect_scanner.jpg#center alt="nRF Connect Scanner"></p><p>连接后，切换到 Client Tab，根据前面记下的 UUID，在 Attribute Table 中找到对应的 Characteristics，并点击向上的箭头（其实在我们的程序里，只有这个 Characteristics 开启了 Write 权限，所以只有它有上箭头，看不看 UUID 意义不大）：</p><p><img loading=lazy src=img/led_controller.jpg#center alt="led controller"></p><p>尝试改变写入的值，就可以看到 LED 灯随着我们的操作被点亮和关闭。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangyuyang.me/tags/c/>C</a></li><li><a href=https://wangyuyang.me/tags/efr32/>EFR32</a></li></ul><nav class=paginav><a class=prev href=https://wangyuyang.me/posts/efr32%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B07-ble%E7%82%B9%E4%BA%AE%E5%91%BC%E5%90%B8%E7%81%AF/><span class=title>« Prev</span><br><span>EFR32 入门笔记 7: BLE 点亮呼吸灯</span></a>
<a class=next href=https://wangyuyang.me/posts/%E9%B2%9C%E5%88%87%E8%8A%B1%E6%B0%B4%E5%9F%B9%E8%AE%B0%E5%BD%95/><span class=title>Next »</span><br><span>鲜切花水培记录</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wangyuyang.me>Yuyang Wang's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>